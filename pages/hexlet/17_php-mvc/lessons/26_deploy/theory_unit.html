<!DOCTYPE html>
<html class='h-100' lang='ru' prefix='og: https://ogp.me/ns#'>

<head>
  <title>Деплой - Веб-разработка на PHP</title>
  <meta content='width=device-width, initial-scale=1.0' name='viewport'>
  <meta charset='utf-8'>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
</head>

<body class='h-100'>
  <div class='d-flex flex-column flex-md-row h-100'>
    <div class='x-border-md-right flex-fill tab-content overflow-hidden h-100'>
      <div aria-labelledby='lesson-tab' class='tab-pane fade show active overflow-auto h-100' id='lesson'
        role='tabpanel'>
        <div class='container-xl my-3 mb-md-4 mb-lg-5'>
          <div class='row justify-content-center'>
            <div class='col-12 col-lg-10'>
              <div class='mt-3 paywall'>
                <div class='p-2 p-md-4 shadow-sm bg-white'>
                  <div class='hexlet-markdown-body overflow-hidden p-2 p-md-4'>
                    <h1 class='mt-0 mb-4'>Деплой</h1>
                    <p>После того как сайт написан, встаёт вопрос о том как выложить его в интернет. Стандартный путь
                      включает три пункта:</p>

                    <ol>
                      <li> Покупка домена</li>
                      <li> Покупка хостинга и его настройка</li>
                      <li> Деплой</li>
                    </ol>

                    <p>Первый я пропущу (скоро мы его опишем в <a href="https://guides.hexlet.io"
                        target="_blank">https://guides.hexlet.io</a>), а вот про два других поговорим.</p>

                    <p><img alt="Deploy" class="lazyload px-2 px-md-3 px-lg-4 px-xl-5"
                        data-src="https://cdn2.hexlet.io/derivations/image/original/eyJpZCI6IjhkNDRlM2M3MDNmYTkwY2ExZGZiNzU1MWY3Njk5NjYzLnBuZyIsInN0b3JhZ2UiOiJjYWNoZSJ9?signature=02ce208b1c498eb3ce299e8124a9d3836afef696513225ad068ecc805d0b6af6"
                        src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" /></p>

                    <p>Деплой — процесс выкладки новой версии сайта на сервер (или сервера). Этот процесс может быть
                      довольно сложным и сильно зависит от используемых технологий. Во время деплоя выполняются
                      следующие задачи (ниже всего лишь один из возможных вариантов, причём довольно примитивный):</p>

                    <ol>
                      <li> Код проекта скачивается на сервер (обычно через клонирование Git)</li>
                      <li> Ставятся все необходимые зависимости</li>
                      <li> Выполняется процесс сборки, например собирается фронтенд-часть</li>
                      <li> Выполняются миграции. Миграции — SQL-скрипты, которые изменяют структуру базы данных</li>
                      <li> Запускается новая версия кода</li>
                    </ol>

                    <p>Как это ни странно, но во многих компаниях прямо сейчас весь этот процесс выполняется руками.
                      Программист заходит на сервер, запускает <code>git pull</code> и далее проходится по списку выше.
                      Это худший способ деплоить. Деплой относится к тем задачам, которые должны быть автоматизированы
                      от и до.</p>

                    <p><img alt="Deploy Notification" class="lazyload px-2 px-md-3 px-lg-4 px-xl-5"
                        data-src="https://cdn2.hexlet.io/derivations/image/original/eyJpZCI6ImNkNGI5NTM4NzgxZGE0ODYzNjBkM2Y5YjJiOGUxYTlhLnBuZyIsInN0b3JhZ2UiOiJjYWNoZSJ9?signature=1c14968d0828abe13ad9d3c7223c0871773d0c140d8303eb9e857c8e42283585"
                        src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" /></p>

                    <p>Несмотря на разнообразие способов деплоя, есть одно важное правило общее для всех — деплоить
                      можно только вперёд! Деплой нельзя «откатывать» (в первую очередь это касается миграций, но про
                      базы мы пока не говорим). Если после или во время деплоя что-то пошло не так, то правильно
                      деплоить снова, но предыдущую версию.</p>

                    <p>Кроме того, деплои можно классифицировать по способу обновления и отката:</p>

                    <ul>
                      <li>Последовательное обновление — сервера обновляются по очереди</li>
                      <li><a href="https://habr.com/post/309832/" target="_blank" rel="nofollow">Сине-Зелёный деплой</a>
                        — полное дублирование инфраструктуры с подменой</li>
                    </ul>

                    <p><em>Отдельно стоит сказать про канареечный релиз (canary release). При таком подходе переключение
                        на использование новой версии происходит постепенно, сначала для небольшого процента
                        пользователей, а затем и для всех.</em></p>

                    <p>Способ деплоя сильно зависит от используемого хостинга и даже способа настройки серверного
                      окружения. Выделяют следующие типы хостингов:</p>

                    <ul>
                      <li>Виртуальный хостинг (Shared Hosting) — самый дешёвый способ размещать сайт в интернете. Такая
                        услуга включает в себя доступ на сервер с уже настроенным программным обеспечением под
                        конкретный стек, например Linux + PHP + MySQL. Этот способ подходит для самых простых сайтов и
                        требует минимальной настройки.</li>
                      <li>VPS/VDS — наиболее сбалансированная услуга, в рамках которой предоставляется виртуальная
                        машина. Плюс в том, что такой вид хостинга позволяет задействовать больше серверных мощностей:
                        ЦПУ, память и диск. Предустановленного ПО нет, всё нужно делать самостоятельно. По сравнению с
                        виртуальным хостингом вы не ограничены в правах и можете настраивать сервер, как вам угодно.
                      </li>
                      <li>Выделенный сервер (Dedicated Server) — сервер (либо свой, либо арендованный). Такой хостинг
                        требует больше всего участия, но зато вы получаете лучшее соотношение производительность/цена.
                      </li>
                      <li>IaaS (Infrastructure as a Service) — инфраструктура как сервис. Вид хостинга, при котором
                        большая часть возможностей представляется как сервис. Как пример Amazon Web Service (AWS).</li>
                      <li>PaaS (Platform as a Service) — платформа как сервис. Наиболее дорогой и самый
                        автоматизированный способ из коробки по размещению сайтов. Выкладка сайта происходит буквально
                        по команде <code>git push</code>. Кроме цены важно учитывать используемые технологии и подходы.
                        PaaS обладает наибольшим числом ограничений по тому, что и как можно делать, но в обмен вы
                        получаете не просто автоматизированный хостинг, но и платформу, которая автоматически
                        «скейлится» (масштабируется) под нагрузку.</li>
                    </ul>

                    <p>Все способы деплоя можно грубо разбить на две большие категории. Деплой на PaaS и деплой на все
                      остальное.</p>
                    <h2 id="paas">PaaS</h2>
                    <p>Самый простой способ начать деплоить. Большинство PaaS-хостеров имеют бесплатные планы,
                      достаточные для выкладки учебных проектов. Из плюсов: не придётся покупать адрес, домен третьего
                      уровня предоставляется бесплатно. Самое популярное PaaS-решение на текущий день — <a
                        href="https://heroku.com/" target="_blank" rel="nofollow">Heroku</a>, у этого сервиса <a
                        href="https://devcenter.heroku.com/start" target="_blank" rel="nofollow">прекрасная
                        документация</a>, следуя которой можно быстро выложить свой первый сайт. Пошаговое руководство,
                      описывающее выкладку сайта на PHP доступно по ссылке: <a
                        href="https://devcenter.heroku.com/articles/getting-started-with-php"
                        target="_blank">https://devcenter.heroku.com/articles/getting-started-with-php</a>. Heroku
                      используется на Хекслете для JavaScript- и PHP-проектов.</p>
                    <pre class="hljs"><code class=sh><span style="color: #008080">$ </span>heroku create
Creating sharp-rain-871... <span style="color: #000000;font-weight: bold">done</span>, stack is cedar-14
https://sharp-rain-871.herokuapp.com/ | https://git.heroku.com/sharp-rain-871.git
Git remote heroku added

<span style="color: #008080">$ </span>git push heroku master
remote: Building <span style="color: #0086B3">source</span>:
remote:
remote: <span style="color: #000080">-----</span><span style="color: #000000;font-weight: bold">&gt;</span> PHP app detected
remote: <span style="color: #000080">-----</span><span style="color: #000000;font-weight: bold">&gt;</span> Bootstrapping...
remote: <span style="color: #000080">-----</span><span style="color: #000000;font-weight: bold">&gt;</span> Installing platform packages...
remote:        NOTICE: No runtime required <span style="color: #000000;font-weight: bold">in </span>composer.json<span style="background-color: #f8f8f8">;</span> requirements
remote:        from dependencies <span style="color: #000000;font-weight: bold">in </span>composer.lock will be used <span style="color: #000000;font-weight: bold">for </span>selection
remote:        - php <span style="color: #000000;font-weight: bold">(</span>7.1.3<span style="color: #000000;font-weight: bold">)</span>
remote:        - apache <span style="color: #000000;font-weight: bold">(</span>2.4.20<span style="color: #000000;font-weight: bold">)</span>
remote:        - nginx <span style="color: #000000;font-weight: bold">(</span>1.8.1<span style="color: #000000;font-weight: bold">)</span>
remote: <span style="color: #000080">-----</span><span style="color: #000000;font-weight: bold">&gt;</span> Installing dependencies...
remote:        Composer version 1.4.1 2017-03-10 09:29:45
remote:        Loading composer repositories with package information
remote:        Installing dependencies from lock file
remote:        Package operations: 12 installs, 0 updates, 0 removals
remote:          - Installing psr/log <span style="color: #000000;font-weight: bold">(</span>1.0.2<span style="color: #000000;font-weight: bold">)</span>: Loading from cache
remote:          - Installing monolog/monolog <span style="color: #000000;font-weight: bold">(</span>1.22.1<span style="color: #000000;font-weight: bold">)</span>: Loading from cache
...
remote:          - Installing symfony/twig-bridge <span style="color: #000000;font-weight: bold">(</span>v3.2.7<span style="color: #000000;font-weight: bold">)</span>: Loading from cache
remote:        Generating optimized autoload files
remote: <span style="color: #000080">-----</span><span style="color: #000000;font-weight: bold">&gt;</span> Preparing runtime environment...
remote: <span style="color: #000080">-----</span><span style="color: #000000;font-weight: bold">&gt;</span> Checking <span style="color: #000000;font-weight: bold">for </span>additional extensions to install...
remote: <span style="color: #000080">-----</span><span style="color: #000000;font-weight: bold">&gt;</span> Discovering process types
remote:        Procfile declares types -&gt; web
remote:
remote: <span style="color: #000080">-----</span><span style="color: #000000;font-weight: bold">&gt;</span> Compressing...
remote:        Done: 14.8M
remote: <span style="color: #000080">-----</span><span style="color: #000000;font-weight: bold">&gt;</span> Launching...
remote:        Released v17
remote:        https://gsphpjon.herokuapp.com/ deployed to Heroku
remote:
remote: Verifying deploy... <span style="color: #000000;font-weight: bold">done</span><span style="color: #0086B3">.</span>
To https://git.heroku.com/gsphpjon.git
 + 264e577...4f2369c master -&gt; master <span style="color: #000000;font-weight: bold">(</span>forced update<span style="color: #000000;font-weight: bold">)</span>
</code></pre>
                    <h2 id="vse-ostalnoe">Все остальное</h2>
                    <p>Если не брать в расчёт самый примитивный виртуальный хостинг, который не позволяет никак
                      настраивать серверное окружение, все остальные виды хостингов имеют схожие задачи для выкладки.
                    </p>

                    <p>Самая первая задача — настроить окружение. Если в виртуальном хостинге всегда есть набор
                      предустановленных программ, то во всех остальных видах хостинга нет ничего, кроме голой
                      операционной системы. Установка необходимого ПО такой же автоматизируемый процесс как процесс
                      деплоя и у него есть даже собственное название — Управление конфигурациями (Configuration
                      Management). Рекомендую использовать Ansible, популярное решение для настройки (На Хекслете есть
                      соответствующий <a href="https://ru.hexlet.io/courses/ansible" target="_blank">курс</a>).</p>
                    <pre class="hljs"><code class=yaml><span style="background-color: #f8f8f8">-</span> <span style="color: #008080">hosts</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">all</span>

  <span style="color: #008080">tasks</span><span style="background-color: #f8f8f8">:</span>

    <span style="background-color: #f8f8f8">-</span> <span style="color: #008080">lineinfile</span><span style="background-color: #f8f8f8">:</span>
        <span style="color: #008080">create</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">yes</span>
        <span style="color: #008080">regexp</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">~/.local</span>
        <span style="color: #008080">path</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">~/.bash_profile</span>
        <span style="color: #008080">line</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">"</span><span style="color: #d14">export</span><span style="color: #008080"> </span><span style="color: #d14">PATH=$PATH:~/.local/bin"</span>

    <span style="background-color: #f8f8f8">-</span> <span style="color: #008080">name</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">install packages</span>
      <span style="color: #008080">apt</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">pkg=python3-pip state=latest update_cache=yes</span>
      <span style="color: #008080">tags</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">pip</span>
      <span style="color: #008080">become</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">yes</span>

    <span style="background-color: #f8f8f8">-</span> <span style="color: #008080">pip</span><span style="background-color: #f8f8f8">:</span>
        <span style="color: #008080">name</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">pip</span>
        <span style="color: #008080">state</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">latest</span>
      <span style="color: #008080">become</span><span style="background-color: #f8f8f8">:</span> <span style="color: #d14">yes</span>
</code></pre>
                    <p>Ключевое понятие Ansible — Playbook (плейбук). Это файл (или файлы) в формате YAML, в котором
                      описывается, что нужно сделать на указанной машине. В каждом плейбуке используются готовые модули,
                      поставляемые вместе с Ansible. Этих модулей сотни, с помощью них можно делать практически всё,
                      начиная от установки программ и заканчивая настройкой сети и управления правами файловой системы.
                      Ansible — универсальный инструмент, с его помощью можно не только настраивать окружение, но и
                      собственно деплоить. Причём для деплоя есть готовый модуль — <a
                        href="https://docs.ansible.com/ansible/latest/modules/deploy_helper_module.html" target="_blank"
                        rel="nofollow">deploy helper</a>.</p>

                    <p>В более продвинутых случаях, там где используется, например, Docker, развёртывание осуществляется
                      системами оркестрации, среди которых выделяется <a href="https://kubernetes.io/" target="_blank"
                        rel="nofollow">Kubernetes</a>.</p>
                    <h2 id="samostoyatelnaya-rabota">Самостоятельная работа</h2>
                    <p>Выложите на Heroku тот код, который вы написали на Slim в течение этого курса.</p>

                    <hr class='my-5'>
                    <h4 class='mb-4'>Дополнительные материалы</h4>
                    <ol>
                      <li class='lead'>
                        <a target="_blank" href="https://ru.hexlet.io/blog/posts/environment">Среды разработки</a>
                      </li>
                      <li class='lead'>
                        <a target="_blank" href="https://ru.atlassian.com/devops">DevOps</a>
                      </li>
                      <li class='lead'>
                        <a target="_blank" href="https://en.wikipedia.org/wiki/Continuous_delivery">Непрерывное
                          развертывание</a>
                      </li>
                      <li class='lead'>
                        <a target="_blank" href="https://terraform.io/">Terraform</a>
                      </li>
                      <li class='lead'>
                        <a target="_blank" href="https://www.ansible.com/">Ansible</a>
                      </li>
                    </ol>

</body>

</html>