<!DOCTYPE html>
<html class='h-100' lang='ru' prefix='og: https://ogp.me/ns#'>

<head>
  <title>Массовое присвоение - PHP: Eloquent (ORM)</title>
  <meta name="csrf-param" content="authenticity_token" />
  <meta name="csrf-token"
    content="kBd9RCap-f1RhoWkvwQsRzyXfkMnzjx9KUM70eFaXrBo_TM6AM_LYu2F8IRrN8lsu_E1rmhFTKFy66G4yfgqjA" />
  <meta name="csp-nonce" />
  <link rel="shortcut icon" type="image/x-icon"
    href="https://cdn2.hexlet.io/assets/favicon-8fa102c058afb01de5016a155d7db433283dc7e08ddc3c4d1aef527c1b8502b6.ico" />
  <meta content='width=device-width, initial-scale=1.0' name='viewport'>
  <meta charset='utf-8'>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
</head>

<body class='h-100'>
  <div class='d-flex flex-column flex-md-row h-100'>
    <div class='x-border-md-right flex-fill tab-content overflow-hidden h-100'>
      <div aria-labelledby='lesson-tab' class='tab-pane fade show active overflow-auto h-100' id='lesson'
        role='tabpanel'>
        <div class='container-xl my-3 mb-md-4 mb-lg-5'>
          <div class='row justify-content-center'>
            <div class='col-12 col-lg-10'>
              <a class="small" data-toggle="collapse" href="theory_unit.html#tips">Ошибки, сложный материал, вопросы
                &gt;</a>
              <div class='collapse' id='tips'>
                <div class='py-3 px-4 x-line-height-15 bg-hexlet-gray mt-3'>
                  <h6 class='font-weight-bold'>Нашли опечатку или неточность?</h6>
                  <p>
                    Выделите текст, нажмите
                    <kbd class='bg-secondary'>ctrl + enter</kbd>
                    и отправьте его нам. В течение нескольких дней мы исправим ошибку или улучшим формулировку.
                  </p>
                  <h6 class='font-weight-bold'>Что-то не получается или материал кажется сложным?</h6>
                  <p class='mb-1'>Загляните в раздел «Обсуждение»:</p>
                  <ul>
                    <li>задайте вопрос. Вы быстрее справитесь с трудностями и прокачаете навык постановки правильных
                      вопросов, что пригодится и в учёбе, и в работе программистом;</li>
                    <li>расскажите о своих впечатлениях. Если курс слишком сложный, подробный отзыв поможет нам сделать
                      его лучше;</li>
                    <li>изучите вопросы других учеников и ответы на них. Это база знаний, которой можно и нужно
                      пользоваться.</li>
                  </ul>
                  <h6 class='font-weight-bold'>Об обучении на Хекслете</h6>
                  <ul class='list-unstyled mb-0'>
                    <li>
                      Статья «<a target="_blank" href="https://guides.hexlet.io/learning">Как учиться и справляться с
                        негативными мыслями</a>»
                    </li>
                    <li>
                      Статья «<a target="_blank" href="https://ru.hexlet.io/blog/posts/traps-learning">Ловушки
                        обучения</a>»
                    </li>
                    <li>
                      Статья «<a target="_blank"
                        href="https://ru.hexlet.io/blog/posts/slozhnye-prostye-zadachi-po-programmirovaniyu">Сложные
                        простые задачи по программированию</a>»
                    </li>
                    <li>
                      Урок «<a target="_blank"
                        href="https://ru.hexlet.io/courses/introduction_to_programming/lessons/hexlet-flow/theory_unit">Как
                        эффективно учиться на Хекслете</a>»
                    </li>
                    <li>
                      Вебинар «<a target="_blank" rel="noopener noreferrer nofollow"
                        href="https://www.youtube.com/watch?v=dCYZppVgGww">Как самостоятельно учиться</a>»
                    </li>
                  </ul>
                </div>
              </div>

              <div class='mt-3 paywall'>
                <div class='p-2 p-md-4 shadow-sm bg-white'>
                  <div class='hexlet-markdown-body overflow-hidden p-2 p-md-4'>
                    <a class="h6 mb-0 font-weight-normal text-muted x-link-only-hover"
                      href="../scopes/exercise_unit.html">PHP: Eloquent (ORM)</a>
                    <h1 class='mt-0 mb-4'>Массовое присвоение</h1>
                    <p>В предыдущем уроке мы устанавливали свойства модели через сеттеры:</p>
                    <pre class="hljs"><code class=php><span style="color: #999999;font-weight: bold">&lt;?php</span>

<span style="color: #008080">$user</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #000000;font-weight: bold">new</span> <span style="color: #445588;font-weight: bold">App\Models\User</span><span style="background-color: #f8f8f8">();</span>
<span style="color: #008080">$user</span><span style="color: #000000;font-weight: bold">-&gt;</span><span style="background-color: #f8f8f8">email</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">'user@email.com'</span><span style="background-color: #f8f8f8">;</span>
<span style="color: #008080">$user</span><span style="color: #000000;font-weight: bold">-&gt;</span><span style="background-color: #f8f8f8">first_name</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #d14">'Pedro'</span><span style="background-color: #f8f8f8">;</span>
</code></pre>
                    <p>Но это не единственный способ установки свойств. Как правило, в веб-разработке модели создаются
                      после заполнения формы пользователем сайта. Данные этой формы приходят на сервер в виде
                      ассоциативного массива. Eloquent, как и большинство ORM, позволяет сразу передать этот массив в
                      конструктор, вместо индивидуальной установки каждого свойства. Такой подход называется
                      &quot;массовым присвоением&quot; (mass-assignment):</p>
                    <pre class="hljs"><code class=php><span style="color: #999999;font-weight: bold">&lt;?php</span>

<span style="color: #999988;font-style: italic">// Обычно это данные пришедшие из формы</span>
<span style="color: #008080">$params</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">[</span><span style="color: #d14">'email'</span> <span style="color: #000000;font-weight: bold">=&gt;</span> <span style="color: #d14">'user@email.com'</span><span style="background-color: #f8f8f8">,</span> <span style="color: #d14">'first_name'</span> <span style="color: #000000;font-weight: bold">=&gt;</span> <span style="color: #d14">'Pedro'</span><span style="background-color: #f8f8f8">];</span>
<span style="color: #008080">$user</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #000000;font-weight: bold">new</span> <span style="color: #445588;font-weight: bold">App\Models\User</span><span style="background-color: #f8f8f8">(</span><span style="color: #008080">$params</span><span style="background-color: #f8f8f8">);</span>
<span style="color: #008080">$user</span><span style="color: #000000;font-weight: bold">-&gt;</span><span style="color: #990000;font-weight: bold">save</span><span style="background-color: #f8f8f8">();</span>
</code></pre>
                    <p>Но если выполнить такой подход в лоб, то он завершится с ошибкой: <em>Add [email] to fillable
                        property to allow mass assignment on [App/Models/User]</em>. Чтобы понять почему так происходит,
                      надо немного поговорить о безопасности.</p>

                    <p>Формы никогда не содержат всех полей. В каждой модели обязательно есть, по крайней мере, одно
                      поле (id), которое нельзя давать менять. Обычно их больше, например различные поля, определяющие
                      состояние, количество денег, какие-то внутренние характеристики, которые можно менять только
                      изнутри системы.</p>

                    <p>Но достаточно ли просто не указывать их в форме? Будет ли это безопасно? Не будет. Веб — это
                      HTTP, а значит любой человек, всегда может послать форму в нужный обработчик добавив туда всё, что
                      угодно. Это автоматически означает, что передача данных пачкой в конструктор может привести к
                      очень нежелательным эффектам. Например, к изменению уровня доступа в систему:</p>
                    <pre class="hljs"><code class=php><span style="color: #999999;font-weight: bold">&lt;?php</span>

<span style="color: #999988;font-style: italic">// Предположим, что в базе есть поле admin,</span>
<span style="color: #999988;font-style: italic">// установив которое, можно получить доступ к административной части приложения.</span>
<span style="color: #008080">$params</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">[</span><span style="color: #d14">'email'</span> <span style="color: #000000;font-weight: bold">=&gt;</span> <span style="color: #d14">'user@email.com'</span><span style="background-color: #f8f8f8">,</span> <span style="color: #d14">'first_name'</span> <span style="color: #000000;font-weight: bold">=&gt;</span> <span style="color: #d14">'Pedro'</span><span style="background-color: #f8f8f8">,</span> <span style="color: #d14">'admin'</span> <span style="color: #000000;font-weight: bold">=&gt;</span> <span style="color: #000000;font-weight: bold">true</span><span style="background-color: #f8f8f8">];</span>
<span style="color: #008080">$user</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #000000;font-weight: bold">new</span> <span style="color: #445588;font-weight: bold">App\Models\User</span><span style="background-color: #f8f8f8">(</span><span style="color: #008080">$params</span><span style="background-color: #f8f8f8">);</span>
<span style="color: #008080">$user</span><span style="color: #000000;font-weight: bold">-&gt;</span><span style="color: #990000;font-weight: bold">save</span><span style="background-color: #f8f8f8">();</span>
</code></pre>
                    <p>Во избежание подобных ситуаций, Eloquent контролирует то, что принимается на вход при массовом
                      присвоении. Делается это с помощью свойства <code>$fillable</code> внутри модели:</p>
                    <pre class="hljs"><code class=php><span style="color: #999999;font-weight: bold">&lt;?php</span>

<span style="color: #000000;font-weight: bold">namespace</span> <span style="color: #555555">App\Models</span><span style="background-color: #f8f8f8">;</span>

<span style="color: #000000;font-weight: bold">use</span> <span style="color: #445588;font-weight: bold">Illuminate\Database\Eloquent\Model</span><span style="background-color: #f8f8f8">;</span>

<span style="color: #000000;font-weight: bold">class</span> <span style="color: #445588;font-weight: bold">User</span> <span style="color: #000000;font-weight: bold">extends</span> <span style="color: #445588;font-weight: bold">Model</span>
<span style="background-color: #f8f8f8">{</span>
    <span style="color: #999988;font-style: italic">// Белый список. Здесь описываются допустимые поля.</span>
    <span style="color: #000000;font-weight: bold">protected</span> <span style="color: #008080">$fillable</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">[</span><span style="color: #d14">'email'</span><span style="background-color: #f8f8f8">,</span> <span style="color: #d14">'first_name'</span><span style="background-color: #f8f8f8">,</span> <span style="color: #d14">'last_name'</span><span style="background-color: #f8f8f8">];</span>
<span style="background-color: #f8f8f8">}</span>
</code></pre>
                    <p>Теперь указанные поля могут использоваться в конструкторе:</p>
                    <pre class="hljs"><code class=php><span style="color: #999999;font-weight: bold">&lt;?php</span>

<span style="color: #008080">$params</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">[</span><span style="color: #d14">'email'</span> <span style="color: #000000;font-weight: bold">=&gt;</span> <span style="color: #d14">'user@email.com'</span><span style="background-color: #f8f8f8">,</span> <span style="color: #d14">'first_name'</span> <span style="color: #000000;font-weight: bold">=&gt;</span> <span style="color: #d14">'Pedro'</span><span style="background-color: #f8f8f8">,</span> <span style="color: #d14">'last_name'</span> <span style="color: #000000;font-weight: bold">=&gt;</span> <span style="color: #d14">'Alexandro'</span><span style="background-color: #f8f8f8">];</span>
<span style="color: #008080">$user</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #000000;font-weight: bold">new</span> <span style="color: #445588;font-weight: bold">App\Models\User</span><span style="background-color: #f8f8f8">(</span><span style="color: #008080">$params</span><span style="background-color: #f8f8f8">);</span>
<span style="color: #008080">$user</span><span style="color: #000000;font-weight: bold">-&gt;</span><span style="color: #990000;font-weight: bold">save</span><span style="background-color: #f8f8f8">();</span> <span style="color: #999988;font-style: italic">// Все пройдёт успешно</span>
</code></pre>
                    <p>Массовое присвоение немного отличается если мы говорим про обновление сущности. Конструктор
                      использовать не получится, сущность уже создана. Для массового обновления полей создан метод
                      <code>fill</code>:</p>
                    <pre class="hljs"><code class=php><span style="color: #999999;font-weight: bold">&lt;?php</span>

<span style="color: #008080">$user</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #445588;font-weight: bold">App\Models\User</span><span style="color: #000000;font-weight: bold">::</span><span style="color: #990000;font-weight: bold">find</span><span style="background-color: #f8f8f8">(</span><span style="color: #008080">$id</span><span style="background-color: #f8f8f8">);</span>
<span style="color: #999988;font-style: italic">// Только обновление, без сохранения</span>
<span style="color: #999988;font-style: italic">// Этот метод так же ориентируется на свойство $fillable</span>
<span style="color: #008080">$user</span><span style="color: #000000;font-weight: bold">-&gt;</span><span style="color: #990000;font-weight: bold">fill</span><span style="background-color: #f8f8f8">([</span><span style="color: #d14">'first_name'</span> <span style="color: #000000;font-weight: bold">=&gt;</span> <span style="color: #d14">'Mike'</span><span style="background-color: #f8f8f8">,</span> <span style="color: #d14">'email'</span> <span style="color: #000000;font-weight: bold">=&gt;</span> <span style="color: #d14">'lala@email.com'</span><span style="background-color: #f8f8f8">]);</span>
<span style="color: #008080">$user</span><span style="color: #000000;font-weight: bold">-&gt;</span><span style="color: #990000;font-weight: bold">save</span><span style="background-color: #f8f8f8">();</span>
</code></pre>
                    <p><em>Откровенно говоря, контроль входных данных это не уровень моделей. Об этом должен заботиться
                        тот слой, который использует модели. Но жизнь сложная штука. Подобные решения принимаются
                        разработчиками фреймворков для упрощения работы. Иначе повышается порог входа. С другой стороны,
                        подобные вещи выходят боком для опытных разработчиков. Что если нам нужно иметь разные наборы
                        полей для разных форм? Eloquent ничего не сможет сделать, потому что набор полей зашивается
                        жёстко внутри модели</em></p>
                    <h2 id="samostoyatelnaya-rabota">Самостоятельная работа</h2>
                    <ol>
                      <li> Заполните <code>$fillable</code> у <em>User</em> если оно не заполнено.</li>
                      <li> Создайте пользователя используя mass-assignment.</li>
                      <li> Обновите любого пользователя используя mass-assignment.</li>
                    </ol>

                    <hr class='my-5'>
                    <h4 class='mb-4'>Дополнительные материалы</h4>
                    <ol>
                      <li class='lead'>
                        <a target="_blank" href="https://laravel.com/docs/8.x/eloquent#mass-assignment">Mass
                          Assigment</a>
                      </li>
                    </ol>
                    <div class="d-flex justify-content-center">
                      <a href="./exercise_unit.html" type="button" class="btn btn-dark">Задача</a>
                    </div>
</body>

</html>